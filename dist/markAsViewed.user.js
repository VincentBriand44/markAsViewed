
// ==UserScript==
// @name         Mark as viewed
// @namespace    http://tampermonkey.net/
// @version      1.7.1
// @description  Mark as viewed on AdKami from Crunchyroll
// @author       Kanon
// @source       https://github.com/VincentBriand44/markAsViewed
// @downloadURL  https://github.com/VincentBriand44/markAsViewed/releases/latest/download/markAsViewed.user.js
// @updateURL    https://github.com/VincentBriand44/markAsViewed/releases/latest/download/markAsViewed.user.js
// @match        http*://*.crunchyroll.com/*
// @match        http*://animationdigitalnetwork.com/video/*
// @match        http*://*.netflix.com/watch/*
// @match        http*://*.netflix.com/title/*
// @match        http*://*.adkami.com/anime*?kaddon*
// @match        http*://*.adkami.com/video?search=*&kaddon=*
// @include      http*://anime-sama.*/catalogue/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=crunchyroll.com
// @grant        GM.setValue
// @grant        GM.getValue
// @grant        GM.listValues
// ==/UserScript==

"use strict";(()=>{var y='<?xml version="1.0" encoding="UTF-8"?><svg id="a" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1011 998.52"><path d="M1003.91,357.4L399.45,990.65c-10,10.48-26.96,9.67-35.93-1.71l-229.93-291.83c-7.47-9.48-6.67-23.04,1.87-31.57l86.34-86.34c10-10,26.45-9.13,35.34,1.86l136.58,168.71c8.94,11.05,25.51,11.85,35.48,1.72L969.71,201.97c14.94-15.19,40.79-4.61,40.79,16.7v122.29c0,6.12-2.36,12.01-6.59,16.44Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M289.45,980.5H20.23c-10.9,0-19.73-8.83-19.73-19.73V20.23C.5,9.33,9.33.5,20.23.5h940.54c10.9,0,19.73,8.83,19.73,19.73v132.1c0,5.23-2.08,10.25-5.78,13.95l-60.54,60.54c-12.43,12.43-33.68,3.63-33.68-13.95v-92.65c0-10.89-8.82-19.72-19.72-19.72-236.26,0-504.31,0-740.57,0-10.89,0-19.72,8.82-19.72,19.72,0,108.52,0,632.03,0,740.56,0,10.9,8.83,19.72,19.73,19.72,41.69,0,78.18,0,120.78,0,6,0,11.67,2.73,15.41,7.41l48.43,60.54c10.33,12.92,1.14,32.05-15.41,32.05Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M538.15,880.5c100.95,0,222.93,0,325.16,0,9.5,0,17.19-7.7,17.19-17.2v-336.16c0-4.28,1.59-8.4,4.47-11.57l65.61-72.17c10.57-11.63,29.92-4.15,29.92,11.57v508.33c0,9.5-7.7,17.2-17.2,17.2h-484.19c-14.89,0-22.74-17.63-12.78-28.7l59.05-65.61c3.26-3.62,7.9-5.69,12.78-5.69Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/></svg>';var k='<?xml version="1.0" encoding="UTF-8"?><svg id="a" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1011 998.52"><path d="M409.4,419.23l-150.66-3.44c-6.28-.14-11.34-5.22-11.46-11.5l-.89-46.39c-.13-6.56,5.16-11.95,11.73-11.95h151.54c6.48,0,11.73,5.25,11.73,11.73v49.83c0,6.58-5.42,11.88-12,11.73Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M506.43,477.03l79.84-.24c4.96-.02,8.98-4.04,8.98-9V160.08c0-4.97-4.03-9-9-9h-87.84c-2.03,0-4.01.69-5.6,1.95l-103.79,82.42c-3.41,2.71-4.39,7.47-2.33,11.31l29.53,54.93c2.62,4.87,8.96,6.25,13.37,2.91,12.83-9.72,37.33-28.67,53.02-40.84,5.91-4.58,14.51-.38,14.52,7.1l.29,197.17c0,4.98,4.05,9,9.03,8.99Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M1003.91,357.4L399.45,990.65c-10,10.48-26.96,9.67-35.93-1.71l-229.93-291.83c-7.47-9.48-6.67-23.04,1.87-31.57l86.34-86.34c10-10,26.45-9.13,35.34,1.86l136.58,168.71c8.94,11.05,25.51,11.85,35.48,1.72L969.71,201.97c14.94-15.19,40.79-4.61,40.79,16.7v122.29c0,6.12-2.36,12.01-6.59,16.44Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M289.45,980.5H20.23c-10.9,0-19.73-8.83-19.73-19.73V20.23C.5,9.33,9.33.5,20.23.5h940.54c10.9,0,19.73,8.83,19.73,19.73v132.1c0,5.23-2.08,10.25-5.78,13.95l-60.54,60.54c-12.43,12.43-33.68,3.63-33.68-13.95v-92.65c0-10.89-8.82-19.72-19.72-19.72-236.26,0-504.31,0-740.57,0-10.89,0-19.72,8.82-19.72,19.72,0,108.52,0,632.03,0,740.56,0,10.9,8.83,19.72,19.73,19.72,41.69,0,78.18,0,120.78,0,6,0,11.67,2.73,15.41,7.41l48.43,60.54c10.33,12.92,1.14,32.05-15.41,32.05Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M538.15,880.5c100.95,0,222.93,0,325.16,0,9.5,0,17.19-7.7,17.19-17.2v-336.16c0-4.28,1.59-8.4,4.47-11.57l65.61-72.17c10.57-11.63,29.92-4.15,29.92,11.57v508.33c0,9.5-7.7,17.2-17.2,17.2h-484.19c-14.89,0-22.74-17.63-12.78-28.7l59.05-65.61c3.26-3.62,7.9-5.69,12.78-5.69Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/></svg>';var h='<?xml version="1.0" encoding="UTF-8"?><svg id="a" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 981 981"><path d="M289.45,980.5H20.23c-10.9,0-19.73-8.83-19.73-19.73V20.23C.5,9.33,9.33.5,20.23.5h940.54c10.9,0,19.73,8.83,19.73,19.73v132.1c0,5.23-2.08,10.25-5.78,13.95l-60.54,60.54c-12.43,12.43-33.68,3.63-33.68-13.95v-92.65c0-10.89-8.82-19.72-19.72-19.72-236.26,0-504.31,0-740.57,0-10.89,0-19.72,8.82-19.72,19.72,0,108.52,0,632.03,0,740.56,0,10.9,8.83,19.72,19.73,19.72,41.69,0,78.18,0,120.78,0,6,0,11.67,2.73,15.41,7.41l48.43,60.54c10.33,12.92,1.14,32.05-15.41,32.05Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M538.15,880.5c100.95,0,222.93,0,325.16,0,9.5,0,17.19-7.7,17.19-17.2v-336.16c0-4.28,1.59-8.4,4.47-11.57l65.61-72.17c10.57-11.63,29.92-4.15,29.92,11.57v508.33c0,9.5-7.7,17.2-17.2,17.2h-484.19c-14.89,0-22.74-17.63-12.78-28.7l59.05-65.61c3.26-3.62,7.9-5.69,12.78-5.69Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><rect x="880.5" y="150.17" width="100" height="397.33" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><rect x="208.83" y="880.5" width="416" height="100" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><rect x="425.83" y="388.08" width="129.33" height="381.75" rx="46.67" ry="46.67" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><rect x="425.83" y="211.17" width="129.33" height="130" rx="64.67" ry="64.67" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/></svg>';var l=null,v=({data:o,seasonState:t})=>{let e=o();return t||l&&l.episode===e.episode&&l.season===e.season&&l.title===e.title?!0:(l=e,!1)},E=async({episodePosition:o,data:t})=>{try{l||(l=t());let{episode:e,season:n,title:i}=l,r=document.querySelector(o);if(!r){console.warn(`\xC9l\xE9ment non trouv\xE9 pour l'injection: ${o}`);return}await x({buttons:[{id:"kaddon-button",icon:y,step:0},{id:"kaddon-button-minus",icon:k,step:-1},{id:"kaddon-button-info",icon:h,step:0,info:!0}],getEpisodeUrl:async(m,g=!1)=>{let d=`https://www.adkami.com/video?search=${encodeURIComponent(i)}`,u=await GM.getValue(i);if(u&&(d=`${u.toString()}/`),n!==null&&m!==null){let w=e+m;u||(d+="&kaddon="),d+=`${w>0?w:1}/1/2/${n}`,u&&!g&&(d+="?kaddon")}return g&&!u&&(d+="&kaddon-info"),d},element:r})}catch(e){console.error("Erreur lors de l'injection du bouton:",e)}},S=async({animePosition:o,data:t})=>{try{if(o===void 0)return;let{title:e}=t(),n=document.querySelector(o);if(!n){console.warn(`\xC9l\xE9ment non trouv\xE9 pour l'injection: ${o}`);return}await x({buttons:[{id:"kaddon-button-info",icon:h,step:0,info:!0}],getEpisodeUrl:()=>`https://www.adkami.com/video?search=${encodeURIComponent(e)}&kaddon=1/1/2/1&kaddon-info`,element:n})}catch(e){console.error("Erreur lors de l'injection du bouton:",e)}},x=async({buttons:o,getEpisodeUrl:t,element:e})=>{let n=document.createElement("div");n.id="kaddon-container",n.style.display="flex",n.style.gap=".25rem",n.style.paddingLeft=".5rem";for(let i of o){let r=document.createElement("a");r.id=i.id,r.href=await Promise.resolve(t(i.step,i.info??!1)),r.target="_blank",r.style.cursor="pointer",r.style.height="1rem",r.style.width="1rem",r.innerHTML=i.icon,n.appendChild(r)}e.after(n)};var q=()=>{let o=document.querySelectorAll(".video-item-list"),t=location.search.split("kaddon=")[1],e=location.search.split("search=")[1].split("&")[0],n=!1,i=!1;if(t.includes("&kaddon-info")&&(n=!0,t=t.replace("&kaddon-info","")),t.includes("&kaddon-lock")&&(i=!0,t=t.replace("&kaddon-lock","")),!n){let s=document.querySelector(".search-input"),a=document.querySelector(".video-search-button");if(!s||!a)return;a.addEventListener("click",m=>{m.preventDefault(),window.location.href=`https://www.adkami.com/video?search=${s.value}&kaddon=${t}&kaddon-lock`})}if(o.length<1)return;for(let s of Array.from(o)){let a=s.querySelector(".top a");a?.href&&(o.length===1&&(console.log(decodeURIComponent(e),a.href),GM.setValue(decodeURIComponent(e),a.href)),a.href=`${a.href}/${t}/?${n?"kaddon-info":"kaddon"}`)}if(o.length>1)return;let r=o[0].querySelector(".top a");!r?.href||i||(window.location.href=r.href)},M=q;var N='script[type="application/ld+json"]';var B=o=>{let t={};for(let e of o)Object.assign(t,e),t.aggregateRating=t.aggregateRating||e.aggregateRating,t.partOfSeason=t.partOfSeason||e.partOfSeason,t.partOfSeries=t.partOfSeries||e.partOfSeries,t.potentialAction=t.potentialAction||e.potentialAction,t.thumbnailUrl=Array.isArray(t.thumbnailUrl)?[...t.thumbnailUrl,...Array.isArray(e.thumbnailUrl)?e.thumbnailUrl:[e.thumbnailUrl]]:[t.thumbnailUrl,...Array.isArray(e.thumbnailUrl)?e.thumbnailUrl:[e.thumbnailUrl]];return t},p=()=>{let o=document.querySelectorAll(N);return Array.from(o).map(t=>{try{return JSON.parse(t.innerText)}catch(e){return console.error("Erreur lors du parsing JSON:",e),null}}).filter(t=>t!==null)},f=(o,t)=>{if(t)return{title:t,episode:0,season:0};let e=B(o),n=e.partOfSeries?.name,i=Number(e.episodeNumber??1),r=e.partOfSeason?.seasonNumber??1;if(!n||!r)throw new Error("Donn\xE9es d'int\xE9gration non trouv\xE9es dans le JSON-LD");return{episode:i,season:r,title:n}};var P=()=>{let o=p(),t;if(location.pathname.split("/video/")[1].split("/")[1]===void 0&&(t=document.querySelector('head>meta[property="og:title"]')?.attributes[1].value.split(" - Anime en streaming")[0],!t))throw new Error("not found title");return f(o,t)},I={data:P,episodePosition:"h1",episodeMutation:'div[data-testid="player-content"]',animePosition:'div[data-testid="vod-rating"]',animeMutation:"h1"};var H=()=>{let o=document.querySelector("#selectEpisodes"),t=document.querySelector("#avOeuvre"),e=document.querySelector("#titreOeuvre")?.textContent,n=Number(o?.value?.split(" ")[1]),i=Number.parseInt(t?.textContent?.split(" ")[1]??"",10);if(!e)throw new Error("data not found");return{episode:n,season:i,title:e}},L={data:H,episodePosition:"#printLastEpisode",episodeMutation:"#selectEpisodes",animePosition:"#addVu",animeMutation:"#addVu"};var j=()=>{let o=p(),t;if(location.pathname.includes("/series/")&&(t=document.querySelector('head>meta[property="og:title"]')?.attributes[1].value.split("Watch ")[1],!t))throw new Error("not found title");return f(o,t)},D={data:j,episodePosition:".current-media-parent-ref",episodeMutation:".show-title-link",animePosition:".bottom-actions-wrapper",animeMutation:".seasons-select"};var W=()=>{if(location.pathname.includes("/title/")){let s=document.querySelector(".about-header > h3 > strong")?.textContent;if(!s)throw new Error("data not found");return{title:s,episode:0,season:0}}let o=document.querySelector('div[data-uia="video-title"]'),t=Number(o?.querySelectorAll("span")[0]?.textContent?.split("E")[1]),e=document.querySelector('div[data-uia="pause-ad-title-display-info-container"] > div > span')?.innerHTML.split("&nbsp;:&nbsp;")[0],n=o?.querySelector("h4")?.textContent,i=t??1,r=Number(e?.startsWith("S")?e.split("S")[1]:1);if(!n||!r)throw new Error("data not found");return{episode:i,season:r,title:n}},T={data:W,episodePosition:'div[data-uia="video-title"]',episodeMutation:'div[data-uia="video-title"]',animePosition:'div[data-uia="mini-modal-controls"] > div:last-child',animeMutation:'div[data-uia="mini-modal-controls"]'};var $=o=>{switch(!0){case o==="www.adkami.com":return;case o==="www.crunchyroll.com":return D;case o==="animationdigitalnetwork.com":return I;case o==="www.netflix.com":return T;case o.startsWith("anime-sama."):return L;default:{console.warn(`Site non support\xE9: ${o}`);return}}},C=$;var c=C(location.host),b=null,Z=()=>{c&&(b&&clearTimeout(b),b=setTimeout(()=>{let o=document.querySelector("#kaddon-container"),t=!1;if(!c.episodeMutation)return;let e=document.querySelector(c.episodeMutation);!e&&c.animeMutation&&(e=document.querySelector(c.animeMutation),t=!0),!(!e||v({data:c.data,seasonState:t})&&o)&&(o?.remove(),t?S(c):E(c))},100))},V=new MutationObserver(Z),J={childList:!0,subtree:!0,attributes:!0};(()=>{if(location.host==="www.adkami.com"){if(location.pathname==="/video"){M();return}let o=location.search;if(o.includes("kaddon-title")){let e=o.split("kaddon-title=")[1],n=location.pathname.split("/")[2];GM.setValue(decodeURIComponent(e),n)}if(o.includes("kaddon-info"))return;let t=document.querySelector("#watchlist-actuel, #watchlist_end");if(t){let e=document.querySelector("h1.title-header-video"),{pathname:n}=window.location,i=n.split("/")[3];if(!e||!e.textContent?.includes(i))return;t.click(),setTimeout(()=>window.close(),1e3)}return}V.observe(document.body,J)})();})();
