
// ==UserScript==
// @name         Mark as viewed
// @namespace    http://tampermonkey.net/
// @version      1.6.5
// @description  Mark as viewed on AdKami from Crunchyroll
// @author       Kanon
// @source       https://github.com/VincentBriand44/markAsViewed
// @downloadURL  https://github.com/VincentBriand44/markAsViewed/releases/latest/download/markAsViewed.user.js
// @updateURL    https://github.com/VincentBriand44/markAsViewed/releases/latest/download/markAsViewed.user.js
// @match        http*://*.crunchyroll.com/*
// @match        http*://*.animationdigitalnetwork.com/video/*
// @match        http*://*.netflix.com/watch/*
// @match        http*://*.adkami.com/anime*?kaddon*
// @match        http*://*.adkami.com/video?search=*&kaddon=*
// @include      http*://anime-sama.*/catalogue/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=crunchyroll.com
// @grant        none
// ==/UserScript==

"use strict";(()=>{var g='<?xml version="1.0" encoding="UTF-8"?><svg id="a" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1011 998.52"><path d="M1003.91,357.4L399.45,990.65c-10,10.48-26.96,9.67-35.93-1.71l-229.93-291.83c-7.47-9.48-6.67-23.04,1.87-31.57l86.34-86.34c10-10,26.45-9.13,35.34,1.86l136.58,168.71c8.94,11.05,25.51,11.85,35.48,1.72L969.71,201.97c14.94-15.19,40.79-4.61,40.79,16.7v122.29c0,6.12-2.36,12.01-6.59,16.44Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M289.45,980.5H20.23c-10.9,0-19.73-8.83-19.73-19.73V20.23C.5,9.33,9.33.5,20.23.5h940.54c10.9,0,19.73,8.83,19.73,19.73v132.1c0,5.23-2.08,10.25-5.78,13.95l-60.54,60.54c-12.43,12.43-33.68,3.63-33.68-13.95v-92.65c0-10.89-8.82-19.72-19.72-19.72-236.26,0-504.31,0-740.57,0-10.89,0-19.72,8.82-19.72,19.72,0,108.52,0,632.03,0,740.56,0,10.9,8.83,19.72,19.73,19.72,41.69,0,78.18,0,120.78,0,6,0,11.67,2.73,15.41,7.41l48.43,60.54c10.33,12.92,1.14,32.05-15.41,32.05Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M538.15,880.5c100.95,0,222.93,0,325.16,0,9.5,0,17.19-7.7,17.19-17.2v-336.16c0-4.28,1.59-8.4,4.47-11.57l65.61-72.17c10.57-11.63,29.92-4.15,29.92,11.57v508.33c0,9.5-7.7,17.2-17.2,17.2h-484.19c-14.89,0-22.74-17.63-12.78-28.7l59.05-65.61c3.26-3.62,7.9-5.69,12.78-5.69Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/></svg>';var k='<?xml version="1.0" encoding="UTF-8"?><svg id="a" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1011 998.52"><path d="M409.4,419.23l-150.66-3.44c-6.28-.14-11.34-5.22-11.46-11.5l-.89-46.39c-.13-6.56,5.16-11.95,11.73-11.95h151.54c6.48,0,11.73,5.25,11.73,11.73v49.83c0,6.58-5.42,11.88-12,11.73Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M506.43,477.03l79.84-.24c4.96-.02,8.98-4.04,8.98-9V160.08c0-4.97-4.03-9-9-9h-87.84c-2.03,0-4.01.69-5.6,1.95l-103.79,82.42c-3.41,2.71-4.39,7.47-2.33,11.31l29.53,54.93c2.62,4.87,8.96,6.25,13.37,2.91,12.83-9.72,37.33-28.67,53.02-40.84,5.91-4.58,14.51-.38,14.52,7.1l.29,197.17c0,4.98,4.05,9,9.03,8.99Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M1003.91,357.4L399.45,990.65c-10,10.48-26.96,9.67-35.93-1.71l-229.93-291.83c-7.47-9.48-6.67-23.04,1.87-31.57l86.34-86.34c10-10,26.45-9.13,35.34,1.86l136.58,168.71c8.94,11.05,25.51,11.85,35.48,1.72L969.71,201.97c14.94-15.19,40.79-4.61,40.79,16.7v122.29c0,6.12-2.36,12.01-6.59,16.44Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M289.45,980.5H20.23c-10.9,0-19.73-8.83-19.73-19.73V20.23C.5,9.33,9.33.5,20.23.5h940.54c10.9,0,19.73,8.83,19.73,19.73v132.1c0,5.23-2.08,10.25-5.78,13.95l-60.54,60.54c-12.43,12.43-33.68,3.63-33.68-13.95v-92.65c0-10.89-8.82-19.72-19.72-19.72-236.26,0-504.31,0-740.57,0-10.89,0-19.72,8.82-19.72,19.72,0,108.52,0,632.03,0,740.56,0,10.9,8.83,19.72,19.73,19.72,41.69,0,78.18,0,120.78,0,6,0,11.67,2.73,15.41,7.41l48.43,60.54c10.33,12.92,1.14,32.05-15.41,32.05Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M538.15,880.5c100.95,0,222.93,0,325.16,0,9.5,0,17.19-7.7,17.19-17.2v-336.16c0-4.28,1.59-8.4,4.47-11.57l65.61-72.17c10.57-11.63,29.92-4.15,29.92,11.57v508.33c0,9.5-7.7,17.2-17.2,17.2h-484.19c-14.89,0-22.74-17.63-12.78-28.7l59.05-65.61c3.26-3.62,7.9-5.69,12.78-5.69Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/></svg>';var m='<?xml version="1.0" encoding="UTF-8"?><svg id="a" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 981 981"><path d="M289.45,980.5H20.23c-10.9,0-19.73-8.83-19.73-19.73V20.23C.5,9.33,9.33.5,20.23.5h940.54c10.9,0,19.73,8.83,19.73,19.73v132.1c0,5.23-2.08,10.25-5.78,13.95l-60.54,60.54c-12.43,12.43-33.68,3.63-33.68-13.95v-92.65c0-10.89-8.82-19.72-19.72-19.72-236.26,0-504.31,0-740.57,0-10.89,0-19.72,8.82-19.72,19.72,0,108.52,0,632.03,0,740.56,0,10.9,8.83,19.72,19.73,19.72,41.69,0,78.18,0,120.78,0,6,0,11.67,2.73,15.41,7.41l48.43,60.54c10.33,12.92,1.14,32.05-15.41,32.05Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><path d="M538.15,880.5c100.95,0,222.93,0,325.16,0,9.5,0,17.19-7.7,17.19-17.2v-336.16c0-4.28,1.59-8.4,4.47-11.57l65.61-72.17c10.57-11.63,29.92-4.15,29.92,11.57v508.33c0,9.5-7.7,17.2-17.2,17.2h-484.19c-14.89,0-22.74-17.63-12.78-28.7l59.05-65.61c3.26-3.62,7.9-5.69,12.78-5.69Z" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><rect x="880.5" y="150.17" width="100" height="397.33" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><rect x="208.83" y="880.5" width="416" height="100" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><rect x="425.83" y="388.08" width="129.33" height="381.75" rx="46.67" ry="46.67" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/><rect x="425.83" y="211.17" width="129.33" height="130" rx="64.67" ry="64.67" fill="#eaeaea" stroke="#1d1d1b" stroke-miterlimit="10"/></svg>';var a=null,w=({data:o,seasonState:e})=>{let t=o();return e||a&&a.episode===t.episode&&a.season===t.season&&a.title===t.title?!0:(a=t,!1)},y=({episodePosition:o,data:e})=>{try{a||(a=e());let{episode:t,season:n,title:i}=a,r=document.querySelector(o);if(!r){console.warn(`\xC9l\xE9ment non trouv\xE9 pour l'injection: ${o}`);return}E({buttons:[{id:"kaddon-button",icon:g,step:0},{id:"kaddon-button-minus",icon:k,step:-1},{id:"kaddon-button-info",icon:m,step:0,info:!0}],getEpisodeUrl:(h,T=!1)=>{let u=`https://www.adkami.com/video?search=${encodeURIComponent(i)}`;if(n!==null&&h!==null){let b=t+h;u+=`&kaddon=${b>0?b:1}/1/2/${n}`}return T&&(u+="&kaddon-info"),u},element:r})}catch(t){console.error("Erreur lors de l'injection du bouton:",t)}},v=({animePosition:o,data:e})=>{try{if(o===void 0)return;let{title:t}=e(),n=document.querySelector(o);if(!n){console.warn(`\xC9l\xE9ment non trouv\xE9 pour l'injection: ${o}`);return}E({buttons:[{id:"kaddon-button-info",icon:m,step:0,info:!0}],getEpisodeUrl:()=>`https://www.adkami.com/video?search=${encodeURIComponent(t)}&kaddon=1/1/2/1&kaddon-info`,element:n})}catch(t){console.error("Erreur lors de l'injection du bouton:",t)}},E=({buttons:o,getEpisodeUrl:e,element:t})=>{let n=document.createElement("div");n.id="kaddon-container",n.style.display="flex",n.style.gap=".25rem",n.style.paddingLeft=".5rem";for(let i of o){let r=document.createElement("a");r.id=i.id,r.href=e(i.step,i.info??!1),r.target="_blank",r.style.cursor="pointer",r.style.height="1rem",r.style.width="1rem",r.innerHTML=i.icon,n.appendChild(r)}t.after(n)};var U=()=>{let o=document.querySelectorAll(".video-item-list"),e=location.search.split("kaddon=")[1],t=!1,n=!1;if(e.includes("&kaddon-info")&&(t=!0,e=e.replace("&kaddon-info","")),e.includes("&kaddon-lock")&&(n=!0,e=e.replace("&kaddon-lock","")),!t){let r=document.querySelector(".search-input"),l=document.querySelector(".video-search-button");if(!r||!l)return;l.addEventListener("click",f=>{f.preventDefault(),window.location.href=`https://www.adkami.com/video?search=${r.value}&kaddon=${e}&kaddon-lock`})}if(o.length<1)return;for(let r of Array.from(o)){let l=r.querySelector(".top a");l?.href&&(l.href=`${l.href}/${e}/?${t?"kaddon-info":"kaddon"}`)}if(o.length>1)return;let i=o[0].querySelector(".top a");!i?.href||n||(window.location.href=i.href)},S=U;var q='script[type="application/ld+json"]';var N=o=>{let e={};for(let t of o)Object.assign(e,t),e.aggregateRating=e.aggregateRating||t.aggregateRating,e.partOfSeason=e.partOfSeason||t.partOfSeason,e.partOfSeries=e.partOfSeries||t.partOfSeries,e.potentialAction=e.potentialAction||t.potentialAction,e.thumbnailUrl=Array.isArray(e.thumbnailUrl)?[...e.thumbnailUrl,...Array.isArray(t.thumbnailUrl)?t.thumbnailUrl:[t.thumbnailUrl]]:[e.thumbnailUrl,...Array.isArray(t.thumbnailUrl)?t.thumbnailUrl:[t.thumbnailUrl]];return e},c=()=>{let o=document.querySelectorAll(q);return Array.from(o).map(e=>{try{return JSON.parse(e.innerText)}catch(t){return console.error("Erreur lors du parsing JSON:",t),null}}).filter(e=>e!==null)},d=(o,e)=>{if(e)return{title:e,episode:0,season:0};console.log(e);let t=N(o),n=t.partOfSeries?.name,i=Number(t.episodeNumber??1),r=t.partOfSeason?.seasonNumber??1;if(!n||!r)throw new Error("Donn\xE9es d'int\xE9gration non trouv\xE9es dans le JSON-LD");return{episode:i,season:r,title:n}};var B=()=>{let o=c();return d(o)},x={data:B,episodePosition:"h1",episodeMutation:"h1 > span"};var H=()=>{let o=document.querySelector("#selectEpisodes"),e=document.querySelector("#avOeuvre"),t=document.querySelector("#titreOeuvre")?.textContent,n=Number(o?.value?.split(" ")[1]),i=Number.parseInt(e?.textContent?.split(" ")[1]??"",10);if(console.log(t,i),!t)throw new Error("data not found");return{episode:n,season:i,title:t}},M={data:H,episodePosition:"#printLastEpisode",episodeMutation:"#selectEpisodes",animePosition:"#addVu",animeMutation:"#addVu"};var j=()=>{let o=c(),e;if(location.pathname.includes("/series/")&&(e=document.querySelector('head>meta[property="og:title"]')?.attributes[1].value.split("Watch ")[1],!e))throw new Error("not found title");return d(o,e)},L={data:j,episodePosition:".current-media-parent-ref",episodeMutation:".show-title-link",animePosition:".bottom-actions-wrapper",animeMutation:".bottom-actions-wrapper"};var P=()=>{let o=document.querySelector('div[data-uia="video-title"]'),e=Number(o?.querySelectorAll("span")[0]?.textContent?.split("E")[1]),t=document.querySelector('div[data-uia="pause-ad-title-display-info-container"] > div > span')?.innerHTML.split("&nbsp;:&nbsp;")[0],n=o?.querySelector("h4")?.textContent,i=e??1,r=Number(t?.startsWith("S")?t.split("S")[1]:1);if(!n||!r)throw new Error("data not found");return{episode:i,season:r,title:n}},I={data:P,episodePosition:'div[data-uia="video-title"]',episodeMutation:'div[data-uia="video-title"]'};var W=o=>{switch(!0){case o==="www.adkami.com":return;case o==="www.crunchyroll.com":return L;case o==="animationdigitalnetwork.com":return x;case o==="www.netflix.com":return I;case o.startsWith("anime-sama."):return M;default:{console.warn(`Site non support\xE9: ${o}`);return}}},D=W;var s=D(location.host),p=null,Z=()=>{s&&(p&&clearTimeout(p),p=setTimeout(()=>{let o=document.querySelector("#kaddon-container"),e=!1;if(!s.episodeMutation)return;let t=document.querySelector(s.episodeMutation);!t&&s.animeMutation&&(t=document.querySelector(s.animeMutation),e=!0),!(!t||w({data:s.data,seasonState:e})&&o)&&(o?.remove(),e?v(s):y(s))},100))},J=new MutationObserver(Z),R={childList:!0,subtree:!0,attributes:!0};(()=>{if(location.host==="www.adkami.com"){if(location.pathname==="/video"){S();return}if(location.search.includes("kaddon-info"))return;let o=document.querySelector("#watchlist-actuel, #watchlist_end");if(o){let e=document.querySelector("h1.title-header-video"),{pathname:t}=window.location,n=t.split("/")[3];if(!e||!e.textContent?.includes(n))return;o.click(),setTimeout(()=>window.close(),1e3)}return}J.observe(document.body,R)})();})();
